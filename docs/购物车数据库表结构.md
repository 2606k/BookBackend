# 购物车数据库表结构

## Cart表结构

```sql
CREATE TABLE `cart` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '购物车ID',
  `openid` varchar(64) NOT NULL COMMENT '用户openid',
  `book_id` bigint NOT NULL COMMENT '书籍ID',
  `book_name` varchar(200) NOT NULL COMMENT '书籍名称（冗余字段）',
  `price` int NOT NULL COMMENT '书籍价格（冗余字段，单位：分）',
  `image_url` varchar(500) DEFAULT NULL COMMENT '书籍图片URL（冗余字段）',
  `quantity` int NOT NULL DEFAULT '1' COMMENT '购买数量',
  `selected` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否选中（0-否，1-是）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_openid` (`openid`),
  KEY `idx_book_id` (`book_id`),
  KEY `idx_openid_book` (`openid`, `book_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='购物车表';
```

## 字段说明

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 |
|--------|------|----------|--------|------|
| id | bigint | 是 | 自增 | 购物车记录唯一标识 |
| openid | varchar(64) | 是 | - | 微信用户的openid |
| book_id | bigint | 是 | - | 关联的书籍ID |
| book_name | varchar(200) | 是 | - | 书籍名称（冗余存储，提升查询性能） |
| price | int | 是 | - | 加入购物车时的书籍价格（分为单位） |
| image_url | varchar(500) | 否 | NULL | 书籍图片URL（冗余存储） |
| quantity | int | 是 | 1 | 购买数量 |
| selected | tinyint(1) | 是 | 1 | 是否选中，用于结算功能 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间（自动更新） |

## 索引说明

1. **主键索引**: `PRIMARY KEY (id)` - 主键，保证记录唯一性
2. **用户索引**: `KEY idx_openid (openid)` - 根据用户查询购物车
3. **商品索引**: `KEY idx_book_id (book_id)` - 根据商品查询
4. **复合索引**: `KEY idx_openid_book (openid, book_id)` - 用户+商品的复合查询，避免重复添加

## 设计理念

### 1. 冗余存储
- **book_name**: 冗余存储书籍名称，避免每次查询都要关联books表
- **price**: 存储加入购物车时的价格，保持价格一致性
- **image_url**: 冗余存储图片URL，提升查询性能

### 2. 业务字段
- **selected**: 支持购物车中商品的选中/取消选中功能，方便结算
- **quantity**: 支持同一商品的数量调整

### 3. 时间戳
- **created_at**: 记录加入购物车的时间
- **updated_at**: 记录最后修改时间，支持按最近更新排序

## 业务约束

1. **唯一性约束**: 同一用户的同一商品在购物车中应该只有一条记录，通过复合索引保证
2. **数量约束**: quantity字段应该大于0
3. **关联约束**: book_id应该关联到有效的books记录
4. **用户约束**: openid应该关联到有效的用户

## 性能优化

1. **索引优化**: 建立了针对常用查询场景的索引
2. **冗余存储**: 通过冗余字段减少关联查询
3. **批量操作**: 支持批量更新选中状态等操作

## 扩展性考虑

1. **规格属性**: 如果书籍有规格（如版本、封面类型），可以增加spec_id字段
2. **优惠信息**: 可以增加discount_price字段存储优惠价格
3. **失效时间**: 可以增加expired_at字段支持购物车过期清理
4. **备注信息**: 可以增加remark字段支持用户备注

## 维护建议

1. **定期清理**: 建议定期清理长时间未更新的购物车记录
2. **数据同步**: 当books表中的商品信息更新时，考虑是否需要同步购物车中的冗余数据
3. **监控异常**: 监控quantity为0或负数的异常数据
4. **容量控制**: 可以限制单个用户购物车中的商品数量上限
