# 微信小程序下单接口快速上手指南

## 快速开始

### 1. 环境准备

确保你的项目已经配置了以下依赖：

```xml
<dependency>
    <groupId>com.wechat.pay</groupId>
    <artifactId>wechatpay-java</artifactId>
    <version>2.4.0</version>
</dependency>
```

### 2. 配置微信支付

在 `application.yml` 中添加配置：

```yaml
wxpay:
  appid: wx1234567890abcdef  # 你的小程序appid
  mch-id: 1234567890         # 你的商户号
  mch-serial-no: 证书序列号
  mch-private-key-file-path: classpath:apiclient_key.pem
  api-v3-key: 你的APIv3密钥
  notify-url: https://your-domain.com/appoint/notify
```

### 3. 小程序端调用示例

```javascript
// 创建订单并支付
function createOrder() {
  wx.request({
    url: 'https://your-domain.com/appoint/create',
    method: 'POST',
    data: {
      openid: 'user_openid_here',
      name: '张三',
      phone: '13800138000',
      address: '北京市朝阳区xxx街道',
      remark: '请尽快发货',
      bookItems: [
        { bookId: 1, quantity: 2 },
        { bookId: 3, quantity: 1 }
      ]
    },
    success: function(res) {
      if (res.data.code === 200) {
        // 调起微信支付
        wx.requestPayment({
          appId: res.data.data.appId,
          timeStamp: res.data.data.timeStamp,
          nonceStr: res.data.data.nonceStr,
          package: res.data.data.package,
          signType: res.data.data.signType,
          paySign: res.data.data.paySign,
          success: function() {
            wx.showToast({
              title: '支付成功',
              icon: 'success'
            });
            // 跳转到订单详情
          },
          fail: function(err) {
            wx.showToast({
              title: '支付失败',
              icon: 'error'
            });
          }
        });
      } else {
        wx.showToast({
          title: res.data.msg,
          icon: 'error'
        });
      }
    }
  });
}
```

### 4. 查询订单

```javascript
// 查询用户订单
function getOrderList(openid) {
  wx.request({
    url: 'https://your-domain.com/appoint/list',
    method: 'GET',
    data: {
      openid: openid,
      page: 1,
      size: 10
    },
    success: function(res) {
      if (res.data.code === 200) {
        console.log('订单列表:', res.data.data.records);
        // 处理订单列表数据
      }
    }
  });
}
```

### 5. 申请退款

```javascript
// 申请退款
function applyRefund(orderId, reason) {
  wx.request({
    url: 'https://your-domain.com/appoint/refund/apply',
    method: 'POST',
    data: {
      orderId: orderId,
      reason: reason || '不想要了'
    },
    success: function(res) {
      if (res.data.code === 200) {
        wx.showToast({
          title: '申请退款成功',
          icon: 'success'
        });
      } else {
        wx.showToast({
          title: res.data.msg,
          icon: 'error'
        });
      }
    }
  });
}
```

## 常见问题

### Q1: 支付失败怎么办？
A: 检查以下几点：
- 确认微信支付配置是否正确
- 检查商户号和appid是否匹配
- 确认私钥文件路径是否正确
- 查看服务器日志获取详细错误信息

### Q2: 订单状态不更新？
A: 检查支付回调地址是否正确配置，确保：
- 回调地址可以公网访问
- 回调接口返回正确的JSON格式
- 服务器防火墙允许微信服务器访问

### Q3: 库存超卖问题？
A: 系统已经做了库存校验，但建议：
- 在高并发场景下使用Redis分布式锁
- 在支付成功后再次校验库存
- 设置合理的库存预警机制

### Q4: 如何测试支付功能？
A: 建议使用微信支付沙箱环境：
- 申请沙箱环境测试账号
- 使用沙箱环境的配置参数
- 使用沙箱环境的测试金额

## 技术支持

如有问题，请联系：
- 邮箱：support@example.com
- 电话：400-123-4567

---

**作者：** tangxin  
**更新时间：** 2024-01-01
