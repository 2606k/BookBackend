<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理控制台 - 图书商城后台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
            padding-top: 20px;
        }
        .sidebar .nav-link {
            color: #adb5bd;
            margin: 5px 15px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover {
            color: #fff;
            background-color: #495057;
        }
        .sidebar .nav-link.active {
            color: #fff;
            background-color: #007bff;
        }
        .main-content {
            padding: 20px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .stats-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0;
        }
        .stats-card .stats-icon {
            font-size: 3rem;
            opacity: 0.3;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .quick-action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            transition: all 0.3s;
            height: 120px;
        }
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            color: white;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .recent-order {
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 0 5px 5px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h5 class="text-white">图书商城管理</h5>
                        <small class="text-muted">Admin Panel</small>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="/admin/dashboard">
                                <i class="bi bi-house-door"></i> 控制台
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/books">
                                <i class="bi bi-book"></i> 书籍管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/categories">
                                <i class="bi bi-tags"></i> 分类管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/orders">
                                <i class="bi bi-cart-check"></i> 订单管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/users">
                                <i class="bi bi-people"></i> 用户管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/statistics">
                                <i class="bi bi-graph-up"></i> 数据统计
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/settings">
                                <i class="bi bi-gear"></i> 系统设置
                            </a>
                        </li>
                        <li class="nav-item mt-3">
                            <a class="nav-link text-danger" href="/admin/logout" onclick="return confirm('确定要退出吗？')">
                                <i class="bi bi-box-arrow-right"></i> 退出登录
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <!-- 顶部导航 -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">管理控制台</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setDateRange('today')">今日</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setDateRange('week')">本周</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary active" onclick="setDateRange('month')">本月</button>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="refreshDashboard()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新数据
                        </button>
                    </div>
                </div>

                <!-- 统计卡片 -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6">
                        <div class="stats-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">总订单数</h6>
                                    <h3 id="totalOrders">--</h3>
                                    <small><i class="bi bi-arrow-up text-success"></i> +12% 较上月</small>
                                </div>
                                <i class="bi bi-cart-check stats-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">销售额</h6>
                                    <h3 id="totalRevenue">--</h3>
                                    <small><i class="bi bi-arrow-up text-success"></i> +8% 较上月</small>
                                </div>
                                <i class="bi bi-currency-dollar stats-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">书籍总数</h6>
                                    <h3 id="totalBooks">--</h3>
                                    <small><i class="bi bi-arrow-up text-success"></i> +5 本新增</small>
                                </div>
                                <i class="bi bi-book stats-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="stats-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">活跃用户</h6>
                                    <h3 id="activeUsers">--</h3>
                                    <small><i class="bi bi-arrow-up text-success"></i> +3% 较上月</small>
                                </div>
                                <i class="bi bi-people stats-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 快捷操作 -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">快捷操作</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <a href="/admin/books" class="btn quick-action-btn w-100 d-flex flex-column justify-content-center">
                                            <i class="bi bi-plus-lg mb-2" style="font-size: 2rem;"></i>
                                            <span>添加书籍</span>
                                        </a>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <a href="/admin/orders" class="btn quick-action-btn w-100 d-flex flex-column justify-content-center">
                                            <i class="bi bi-eye mb-2" style="font-size: 2rem;"></i>
                                            <span>查看订单</span>
                                        </a>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <button onclick="exportData()" class="btn quick-action-btn w-100 d-flex flex-column justify-content-center">
                                            <i class="bi bi-download mb-2" style="font-size: 2rem;"></i>
                                            <span>导出数据</span>
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <a href="/admin/statistics" class="btn quick-action-btn w-100 d-flex flex-column justify-content-center">
                                            <i class="bi bi-graph-up mb-2" style="font-size: 2rem;"></i>
                                            <span>数据分析</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 图表和数据 -->
                <div class="row">
                    <!-- 销售趋势图 -->
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">销售趋势</h5>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary active" onclick="updateChart('sales')">销售额</button>
                                    <button class="btn btn-outline-primary" onclick="updateChart('orders')">订单数</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="salesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 订单状态分布 -->
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">订单状态分布</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="orderStatusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 最近订单和热销书籍 -->
                <div class="row">
                    <!-- 最近订单 -->
                    <div class="col-md-7">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">最近订单</h5>
                                <a href="/admin/orders" class="btn btn-sm btn-outline-primary">查看全部</a>
                            </div>
                            <div class="card-body">
                                <div id="recentOrders">
                                    <div class="text-center text-muted py-4">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        正在加载最近订单...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 热销书籍 -->
                    <div class="col-md-5">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">热销书籍 TOP5</h5>
                            </div>
                            <div class="card-body">
                                <div id="topBooks">
                                    <div class="text-center text-muted py-4">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        正在加载热销数据...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let salesChart, orderStatusChart;
        let currentDateRange = 'month';

        $(document).ready(function() {
            loadDashboardData();
            initCharts();
        });

        function loadDashboardData() {
            loadStatistics();
            loadRecentOrders();
            loadTopBooks();
        }

        function loadStatistics() {
            // 加载真实统计数据
            $.get('/admin/api/statistics', function(response) {
                if (response.code === 200) {
                    const data = response.data;
                    $('#totalOrders').text(data.totalOrders || 0);
                    $('#totalRevenue').text('¥' + (data.totalRevenue || 0).toLocaleString());
                    $('#totalBooks').text(data.totalBooks || 0);
                    $('#activeUsers').text(data.totalUsers || 0);
                } else {
                    showAlert('加载统计数据失败: ' + response.msg, 'warning');
                }
            }).fail(function() {
                // 加载失败时显示默认数据
                $('#totalOrders').text('--');
                $('#totalRevenue').text('--');
                $('#totalBooks').text('--');
                $('#activeUsers').text('--');
                showAlert('加载统计数据失败，请检查网络连接', 'danger');
            });
        }

        function loadRecentOrders() {
            // 模拟最近订单数据
            setTimeout(() => {
                const orders = [
                    {
                        id: '20241215001',
                        customer: '张三',
                        amount: 158.00,
                        status: '已支付',
                        time: '2024-12-15 14:30'
                    },
                    {
                        id: '20241215002',
                        customer: '李四',
                        amount: 89.50,
                        status: '待支付',
                        time: '2024-12-15 14:25'
                    },
                    {
                        id: '20241215003',
                        customer: '王五',
                        amount: 267.80,
                        status: '已支付',
                        time: '2024-12-15 14:20'
                    },
                    {
                        id: '20241215004',
                        customer: '赵六',
                        amount: 45.00,
                        status: '申请退款',
                        time: '2024-12-15 14:15'
                    }
                ];

                const ordersHtml = orders.map(order => {
                    const statusClass = {
                        '已支付': 'success',
                        '待支付': 'warning',
                        '申请退款': 'info'
                    };
                    
                    return `
                        <div class="recent-order">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">${order.id}</div>
                                    <small class="text-muted">${order.customer} · ${order.time}</small>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold text-primary">¥${order.amount.toFixed(2)}</div>
                                    <span class="badge bg-${statusClass[order.status]} badge-sm">${order.status}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                $('#recentOrders').html(ordersHtml);
            }, 800);
        }

        function loadTopBooks() {
            // 模拟热销书籍数据
            setTimeout(() => {
                const books = [
                    {name: 'Java编程思想', sales: 156, trend: '+12%'},
                    {name: 'Spring Boot实战', sales: 134, trend: '+8%'},
                    {name: 'MySQL必知必会', sales: 98, trend: '+15%'},
                    {name: 'Redis设计与实现', sales: 87, trend: '+5%'},
                    {name: 'JavaScript高级程序设计', sales: 76, trend: '+3%'}
                ];

                const booksHtml = books.map((book, index) => `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="badge bg-primary me-2">${index + 1}</span>
                            <span class="fw-bold">${book.name}</span>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">${book.sales}</div>
                            <small class="text-success">${book.trend}</small>
                        </div>
                    </div>
                `).join('');

                $('#topBooks').html(booksHtml);
            }, 1000);
        }

        function initCharts() {
            // 销售趋势图
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                    datasets: [{
                        label: '销售额',
                        data: [12000, 19000, 15000, 25000, 22000, 30000, 28000, 35000, 32000, 38000, 42000, 45000],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // 订单状态分布图
            const statusCtx = document.getElementById('orderStatusChart').getContext('2d');
            orderStatusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['已支付', '待支付', '申请退款', '已退款'],
                    datasets: [{
                        data: [65, 20, 10, 5],
                        backgroundColor: [
                            '#28a745',
                            '#ffc107',
                            '#17a2b8',
                            '#6c757d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateChart(type) {
            // 更新图表数据
            $('.btn-group .btn').removeClass('active');
            event.target.classList.add('active');
            
            if (type === 'orders') {
                salesChart.data.datasets[0].label = '订单数';
                salesChart.data.datasets[0].data = [45, 78, 65, 89, 76, 98, 87, 105, 95, 112, 125, 134];
                salesChart.options.scales.y.ticks.callback = function(value) {
                    return value + ' 单';
                };
            } else {
                salesChart.data.datasets[0].label = '销售额';
                salesChart.data.datasets[0].data = [12000, 19000, 15000, 25000, 22000, 30000, 28000, 35000, 32000, 38000, 42000, 45000];
                salesChart.options.scales.y.ticks.callback = function(value) {
                    return '¥' + value.toLocaleString();
                };
            }
            salesChart.update();
        }

        function setDateRange(range) {
            currentDateRange = range;
            $('.btn-group .btn').removeClass('active');
            event.target.classList.add('active');
            
            // 根据时间范围更新数据
            loadDashboardData();
            showAlert(`已切换到${range === 'today' ? '今日' : range === 'week' ? '本周' : '本月'}数据`, 'info');
        }

        function refreshDashboard() {
            loadDashboardData();
            showAlert('数据已刷新', 'success');
        }

        function exportData() {
            showAlert('正在导出数据，请稍候...', 'info');
            
            // 模拟导出过程
            setTimeout(() => {
                showAlert('数据导出完成', 'success');
            }, 2000);
        }

        function showAlert(message, type = 'info') {
            const alert = $(`
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            $('.main-content').prepend(alert);
            setTimeout(() => alert.alert('close'), 3000);
        }
    </script>
</body>
</html> 